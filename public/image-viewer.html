<!DOCTYPE html>
<html>
<head>
    <title>Image Viewer & Gemini Analysis</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff00;
        }
        .camera-item {
            background: #111;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #0099ff;
            cursor: pointer;
        }
        .camera-item:hover {
            background: #222;
        }
        .selected {
            border-left: 3px solid #00ff00;
            background: #1a3a1a;
        }
        img {
            max-width: 100%;
            border: 2px solid #00ff00;
            margin: 10px 0;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #0099ff; }
        pre {
            background: #0a0a0a;
            padding: 10px;
            overflow-x: auto;
            border-left: 3px solid #00ff00;
            white-space: pre-wrap;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üîç Image Viewer & Gemini Analysis Debugger</h1>

    <div class="section">
        <h2>üì∑ Select Camera/Image</h2>
        <div id="cameraList"></div>
    </div>

    <div class="grid">
        <div class="section">
            <h2>üñºÔ∏è Image</h2>
            <div id="imageDisplay"></div>
        </div>

        <div class="section">
            <h2>ü§ñ Gemini Analysis</h2>
            <div id="analysisDisplay"></div>
            <button id="reanalyzeBtn" onclick="reanalyzeImage()" style="display:none;">üîÑ Re-analyze This Image</button>
        </div>
    </div>

    <div class="section">
        <h2>üìã Full JSON Response</h2>
        <pre id="jsonDisplay"></pre>
    </div>

    <script type="module">
        const GEMINI_API_KEY = 'AIzaSyCgWfldgG8-c7gXRQBS-MpFmipZJ0KNqd0';
        let selectedImage = null;

        window.loadCameras = function() {
            // Get all images from localStorage
            const imageKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('qew_image_'))
                .sort()
                .reverse();

            if (imageKeys.length === 0) {
                document.getElementById('cameraList').innerHTML = '<p class="error">‚ùå No images found</p>';
                return;
            }

            // Group by camera/view
            const imagesByCamera = {};
            imageKeys.forEach(key => {
                const imageData = localStorage.getItem(key);
                if (imageData) {
                    const img = JSON.parse(imageData);
                    const cameraKey = `${img.cameraId}_${img.viewId}`;
                    if (!imagesByCamera[cameraKey]) {
                        imagesByCamera[cameraKey] = [];
                    }
                    imagesByCamera[cameraKey].push(img);
                }
            });

            let html = '';
            Object.keys(imagesByCamera).sort().forEach(cameraKey => {
                const images = imagesByCamera[cameraKey];
                const firstImg = images[0];

                html += `
                    <div class="camera-item" onclick="selectCamera('${cameraKey}')">
                        <p><strong>511ON Camera ID:</strong> ${firstImg.viewId} | <strong>Internal ID:</strong> ${firstImg.cameraId}</p>
                        <p><strong>Location:</strong> ${firstImg.metadata.cameraLocation || 'Unknown'}</p>
                        <p><strong>Images:</strong> ${images.length}</p>
                        <p><strong>Latest:</strong> ${new Date(images[0].timestamp).toLocaleString()}</p>
                    </div>
                `;
            });

            document.getElementById('cameraList').innerHTML = html;
        };

        window.selectCamera = function(cameraKey) {
            // Get all images for this camera
            const imageKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('qew_image_'))
                .sort()
                .reverse();

            const images = imageKeys
                .map(key => JSON.parse(localStorage.getItem(key)))
                .filter(img => `${img.cameraId}_${img.viewId}` === cameraKey);

            if (images.length === 0) return;

            // Use the latest image
            selectedImage = images[0];

            // Highlight selected camera
            document.querySelectorAll('.camera-item').forEach(el => el.classList.remove('selected'));
            event.target.closest('.camera-item').classList.add('selected');

            // Display image
            document.getElementById('imageDisplay').innerHTML = `
                <p class="info"><strong>Image:</strong> ${selectedImage.filename}</p>
                <p class="info"><strong>Captured:</strong> ${new Date(selectedImage.timestamp).toLocaleString()}</p>
                <p class="info"><strong>Size:</strong> ${(selectedImage.size / 1024).toFixed(1)} KB</p>
                <img src="${selectedImage.data}" alt="Camera ${selectedImage.cameraId}">
            `;

            // Show re-analyze button
            document.getElementById('reanalyzeBtn').style.display = 'inline-block';

            // Clear analysis display
            document.getElementById('analysisDisplay').innerHTML = '<p class="warning">Click "Re-analyze This Image" to see what Gemini detects</p>';
            document.getElementById('jsonDisplay').textContent = '';
        };

        window.reanalyzeImage = async function() {
            if (!selectedImage) {
                alert('Please select an image first');
                return;
            }

            document.getElementById('analysisDisplay').innerHTML = '<p class="warning">üîÑ Analyzing with Gemini 2.0 Flash...</p>';
            document.getElementById('jsonDisplay').textContent = '';

            try {
                const analysis = await analyzeImageWithGemini(selectedImage);

                // Display analysis in readable format
                let html = `
                    <h3>${analysis.hasWorkZone ? '‚úÖ WORK ZONE DETECTED' : '‚ùå NO WORK ZONE'}</h3>
                    <p class="info"><strong>Confidence:</strong> ${(analysis.confidence * 100).toFixed(0)}%</p>
                    <p class="${analysis.riskScore >= 7 ? 'error' : analysis.riskScore >= 5 ? 'warning' : 'success'}">
                        <strong>Risk Score:</strong> ${analysis.riskScore}/10
                    </p>
                    <hr>
                    <p><strong>Workers:</strong> ${analysis.workers}</p>
                    <p><strong>Vehicles:</strong> ${analysis.vehicles}</p>
                    <p><strong>Barriers:</strong> ${analysis.barriers ? 'Yes' : 'No'}</p>
                    <p><strong>High-Vis Clothing:</strong> ${analysis.highVisClothing ? 'Yes' : 'No'}</p>
                    <p><strong>Hard Hats:</strong> ${analysis.hardHats ? 'Yes' : 'No'}</p>
                    <p><strong>Worker Distance:</strong> ${analysis.workerDistance}m</p>
                    <hr>
                    <p><strong>Advance Warnings:</strong> ${analysis.advanceWarnings ? 'Yes' : 'No'}</p>
                    <p><strong>Arrow Board:</strong> ${analysis.arrowBoard ? 'Yes' : 'No'}</p>
                    <p><strong>Flashing Lights:</strong> ${analysis.flashingLights ? 'Yes' : 'No'}</p>
                    <hr>
                    <p><strong>MTO BOOK 7 Compliant:</strong> ${analysis.mtoBookCompliance ? '‚úÖ Yes' : '‚ùå No'}</p>
                `;

                if (analysis.hazards && analysis.hazards.length > 0) {
                    html += `<hr><p class="error"><strong>Hazards:</strong></p><ul>`;
                    analysis.hazards.forEach(h => html += `<li>${h}</li>`);
                    html += `</ul>`;
                }

                if (analysis.violations && analysis.violations.length > 0) {
                    html += `<p class="error"><strong>Violations:</strong></p><ul>`;
                    analysis.violations.forEach(v => html += `<li>${v}</li>`);
                    html += `</ul>`;
                }

                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += `<hr><p class="info"><strong>Recommendations:</strong></p><ul>`;
                    analysis.recommendations.forEach(r => html += `<li>${r}</li>`);
                    html += `</ul>`;
                }

                document.getElementById('analysisDisplay').innerHTML = html;
                document.getElementById('jsonDisplay').textContent = JSON.stringify(analysis, null, 2);

            } catch (error) {
                document.getElementById('analysisDisplay').innerHTML = `<p class="error">‚ùå Analysis failed: ${error.message}</p>`;
                document.getElementById('jsonDisplay').textContent = error.stack;
            }
        };

        async function analyzeImageWithGemini(imageRecord) {
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: `You are an MTO-certified work zone safety inspector analyzing this highway construction zone image.

Perform a comprehensive safety analysis following Ontario's MTO BOOK 7 standards (Ontario Traffic Manual - Temporary Conditions).

ANALYZE THE IMAGE FOR:

1. WORK ZONE PRESENCE
   - Is there ANY construction work zone visible? (yes/no)
   - Include BOTH active (workers present) AND inactive (equipment/barriers only) work zones
   - A work zone includes ANY of the following:
     * Construction workers visible
     * Construction vehicles (dump trucks, cement mixers, excavators, work trucks)
     * Safety barriers, traffic cones, or barrels
     * Construction equipment (even if stationary)
     * Lane closures or traffic restrictions
     * Construction signage or arrow boards
     * Work zone setup equipment
   - Confidence level (0-100%)

2. WORKER SAFETY ELEMENTS (if work zone present)
   - How many workers are visible?
   - Are they wearing high-visibility clothing? (fluorescent orange/yellow)
   - Are hard hats visible?
   - Distance of workers from active traffic lanes (meters estimate)
   - Are safety barriers present between workers and traffic?

3. TRAFFIC CONTROL DEVICES
   - Are advance warning signs visible?
   - Are channelizing devices present? (cones, barrels)
   - Is an arrow board visible?
   - Are reduced speed limit signs posted?

4. VEHICLE AND EQUIPMENT SAFETY
   - Are construction vehicles present?
   - Do vehicles have flashing amber lights?
   - Is shadow vehicle protecting workers?
   - Is equipment positioned safely?

5. RISK ASSESSMENT
   - Calculate risk score (1-10 scale)
     * 1-3: COMPLIANT (all safety measures present)
     * 4-6: MINOR NON-COMPLIANCE (1-2 issues)
     * 7-8: MAJOR NON-COMPLIANCE (multiple violations)
     * 9-10: CRITICAL VIOLATION (imminent danger)

6. MTO BOOK 7 COMPLIANCE
   - List any violations detected
   - Identify specific hazards

7. RECOMMENDATIONS
   - Immediate actions required (if risk score ‚â• 7)
   - Long-term improvements

IMPORTANT: A work zone includes ANY of the following:
- Construction workers visible
- Construction vehicles (dump trucks, cement mixers, excavators)
- Safety barriers, cones, or barrels
- Construction equipment
- Lane closures or restrictions
- Construction signage
Set hasWorkZone=true if you see ANY of the above, even without active workers.

OUTPUT FORMAT (JSON only, no markdown):
{
  "hasWorkZone": boolean,
  "confidence": 0.0-1.0,
  "riskScore": 1-10,
  "workers": number,
  "vehicles": number,
  "barriers": boolean,
  "highVisClothing": boolean,
  "hardHats": boolean,
  "workerDistance": number (meters),
  "advanceWarnings": boolean,
  "arrowBoard": boolean,
  "flashingLights": boolean,
  "hazards": ["hazard1", "hazard2", ...],
  "violations": ["violation1", "violation2", ...],
  "mtoBookCompliance": boolean,
  "recommendations": ["action1", "action2", ...],
  "analysisTimestamp": "ISO8601 string"
}

Respond ONLY with valid JSON. No markdown, no code blocks, just raw JSON.`
                                },
                                {
                                    inline_data: {
                                        mime_type: 'image/jpeg',
                                        data: imageRecord.data.split(',')[1]
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.4,
                            topK: 32,
                            topP: 1,
                            maxOutputTokens: 2048,
                        }
                    })
                }
            );

            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status} - ${await response.text()}`);
            }

            const result = await response.json();
            const textContent = result.candidates[0].content.parts[0].text;

            // Clean markdown if present
            const cleanedText = textContent
                .replace(/```json\n?/g, '')
                .replace(/```\n?/g, '')
                .trim();

            const analysis = JSON.parse(cleanedText);
            analysis.analysisTimestamp = new Date().toISOString();

            return analysis;
        }

        // Load cameras on page load
        loadCameras();
    </script>
</body>
</html>
